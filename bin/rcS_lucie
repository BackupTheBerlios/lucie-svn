#! /usr/bin/ruby1.8

require 'rake'

# create ramdisk

sh %{mount -n -t proc proc /proc}
# start devfsd if needed
if FileTest.chardev?( '/dev/.devfsd' )
  sh %{/sbin/devfsd /dev}
end

# if we have shm use it as ramdisk
rc = sh %{mount -t tmpfs tmpfs /tmp}
unless rc
  sh %{mke2fs -q -m 0 /dev/ram0}
  sh %{mount -n /dev/ram0 /tmp}
end

# now create the required subdirectories
mkdir_p '/tmp/etc'
mkdir_p '/tmp/target'
mkdir_p '/tmp/var/run/sshd'
mkdir_p '/tmp/var/state/discover'
mkdir_p '/tmp/var/lib/discover'

mkdir '/tmp/var/tmp'
mkdir '/tmp/var/log'
mkdir '/tmp/var/lock'
mkdir '/tmp/var/spool'


# init

# directory where temporary log files are stored.
$logdir = '/tmp/lucie'
mkdir_p '/tmp/lucie'

sh %{grep -q '[[:space:]]sysfs' /proc/filesystems && mount -t sysfs sysfs /sys} rescue nil
sh %{ifup lo} rescue nil
sh %{[ -x /sbin/portmap ] && /sbin/portmap} rescue nil
sh %{mount -t devpts devpts /dev/pts}
# add other options for nfs mount of /dev/root to root-path in dhcpd.conf
sh %{mount -o remount,noatime,ro /dev/root /}
sh %{cat /proc/kmsg >/dev/tty4 &}
sh %{dmesg > #{File.join($logdir, 'dmesg.log')}}

sleep 10
